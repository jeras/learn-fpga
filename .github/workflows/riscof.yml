name: NEORV32 RISCOF Verification

on:
  push:
  pull_request:
  workflow_dispatch:

jobs:

  femtorv-verification:
    runs-on: ubuntu-latest

    steps:

    - name: 'üìÇ Repository checkout'
      uses: actions/checkout@v6
      with:
        fetch-depth: 0
        submodules: recursive

    - name: 'üì¶ Install ccache'
      run: |
        sudo apt-get update
        sudo apt-get install ccache

    - name: 'üì¶ Install Verilator'
      uses: veryl-lang/setup-verilator@v1.0.2
      with:
        version: latest
  
    # somehow veryl-lang/setup-verilator uses mold
    - name: 'üì¶ Install mold linker'
      uses: rui314/setup-mold@v1

    - name: 'üì¶ Install RISC-V toolchain'
      run: |
        curl -L -O https://github.com/riscv-collab/riscv-gnu-toolchain/releases/download/2025.01.20/riscv32-elf-ubuntu-24.04-gcc-nightly-2025.01.20-nightly.tar.xz
        mkdir $GITHUB_WORKSPACE/riscv-toolchain
        tar -xf riscv32-elf-ubuntu-24.04-gcc-nightly-2025.01.20-nightly.tar.xz -C $GITHUB_WORKSPACE/riscv-toolchain
        echo $GITHUB_WORKSPACE/riscv-toolchain/riscv/bin >> $GITHUB_PATH

    - name: 'üì¶ Install Sail RISC-V reference model'
      run: |
        curl -L -O https://github.com/riscv/sail-riscv/releases/download/0.9/sail-riscv-Linux-x86_64.tar.gz
        mkdir $GITHUB_WORKSPACE/riscv-sail
        tar -xzf $GITHUB_WORKSPACE/sail-riscv-Linux-x86_64.tar.gz -C $GITHUB_WORKSPACE/riscv-sail
        echo $GITHUB_WORKSPACE/riscv-sail/sail-riscv-Linux-x86_64/bin >> $GITHUB_PATH

    - name: 'üì¶ Install RISCOF'
      run: |
        echo "RISCOF upstream main is broken! https://github.com/riscv-software-src/riscof/issues/122"
        pip3 install git+https://github.com/riscv/riscof.git@d38859f85fe407bcacddd2efcd355ada4683aee4

    - name: 'üì¶ Install RISC-V Architecture Test SIG'
      working-directory: FemtoRV/RISCOF
      run: |
        curl -L -J -O https://github.com/riscv-non-isa/riscv-arch-test/archive/refs/tags/3.10.0.tar.gz
        tar -xzf riscv-arch-test-3.10.0.tar.gz

    - name: 'üîç Check tools'
      run: |
        verilator --version
        riscv32-unknown-elf-gcc --version
        sail_riscv_sim --version
        riscof --version

    - name: '‚öôÔ∏è Run RISCOF for quark'
      working-directory: FemtoRV/RISCOF
      run: riscof run --config=config-quark.ini         --suite=riscv-arch-test-3.10.0/riscv-test-suite/ --env=riscv-arch-test-3.10.0/riscv-test-suite/env --no-browser

    - name: '‚öôÔ∏è Run RISCOF for quark_bicycle'
      working-directory: FemtoRV/RISCOF
      run: riscof run --config=config-quark_bicycle.ini --suite=riscv-arch-test-3.10.0/riscv-test-suite/ --env=riscv-arch-test-3.10.0/riscv-test-suite/env --no-browser

    - name: '‚öôÔ∏è Run RISCOF for tachyon'
      working-directory: FemtoRV/RISCOF
      run: riscof run --config=config-tachyon.ini       --suite=riscv-arch-test-3.10.0/riscv-test-suite/ --env=riscv-arch-test-3.10.0/riscv-test-suite/env --no-browser

    - name: '‚öôÔ∏è Run RISCOF for electron'
      working-directory: FemtoRV/RISCOF
      run: riscof run --config=config-electron.ini      --suite=riscv-arch-test-3.10.0/riscv-test-suite/ --env=riscv-arch-test-3.10.0/riscv-test-suite/env --no-browser

    - name: 'üì§ Archive test report'
      uses: actions/upload-artifact@v5
      with:
        name: test_report
        path: |
          FemtoRV/RISCOF/riscof_work/report.html
          FemtoRV/RISCOF/riscof_work/style.css
